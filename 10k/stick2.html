<!doctype html>
<html>
<head>
  <title>Stick2 &alpha;</title>
  <style>
  body{
        font-family: arial, sans-serif;
        font-size: 13px;
        background-color: #DFE8F6;
  }
</style>

<meta name = "viewport" content = "user-scalable=no, width=device-height">
<meta name="apple-mobile-web-app-capable" content="yes"> 

</head>
<body style="margin: 0; border: 0; padding: 0;overflow:hidden">
  <div id="canvas" style="position: absolute;top:0;left:0; width: 100%; height: 100%; top: 0px; left: 0px;margin:0;padding:0;border:0"></div>

  <script type="text/javascript">
    small_screen = false;
    var mobilewebkit = navigator.userAgent.indexOf("WebKit") != -1 && navigator.userAgent.indexOf("Mobile")!=-1;

    //yayquery, it turns out its a space not a comma, so uh, this variable is useless
    
    var MOUSEUP = "mouseup";
    var MOUSEDOWN = "mousedown";
    var MOUSEMOVE = "mousemoveE";


    var length_locked = true;
    
    

    draw = null;
    current_shape = null;
    selected_shape = null; //selected != current
    shadow_shape = null;
    resize_stage = false;
  	handle_size = 8;
    onion_skins = [];
	  playback = false;
	  fps = 15;
	  playback_items = [];    
		

		  stage = {
    	x: 180,
    	y: 100, //TODO: ste proportionally to size
    	width: 400,
    	height: 300
    	}
	
    fig_list = [];
    framestore = {};
  	current_frame = 0;
  	frame_el = [];			
	
		
    function render_info(){
          if(shadow_shape){
               shadow_shape.attr("stroke-width", "1px");
               shadow_shape.attr("stroke", "#000000");
               shadow_shape = null;
            }
      if(selected_shape){
          $(".shape_selected").show()
					$(".infobox").show();
					$("#type").text(selected_shape.type)

					if(selected_shape.type != "root"){
						$("#info").show();
		        $("#rootinfo").hide();
	          $("#angle").text(Math.floor(selected_shape._angle*(180/Math.PI)))
	          $("#length").text(Math.floor(selected_shape.length))
	          $("#color").css("color", selected_shape.color)
	          
	          $("#width").text(selected_shape.width);
	          
					}else{
		        $("#info").hide();
		        $("#rootinfo").show();
					}

					var sse = selected_shape.end || selected_shape.shape;
          sse.attr("stroke", "#c598ec");
          sse.attr("stroke-width", "5px");
          shadow_shape = sse;
      }else{
        $(".shape_selected").hide()
        //if(shadow_shape) shadow_shape.remove();
        $("#info").hide();
        $("#rootinfo").hide();
				$(".infobox").hide();
      }
    }
    
    setInterval(render_info, 100);

    function picked_color(){
      var color = colorpicker.color();
      selected_shape.color = color;
      selected_shape.renderAll();
      $("#colorpicker").hide();
    }
    
    $(document).ready(function(){
        $("#angle").parent().click(function(){
          var ang = prompt("Enter new angle",Math.floor(selected_shape._angle*(180/Math.PI)))
          if(ang !== null && ang !== undefined){
            selected_shape._angle = ang / (180/Math.PI);
            selected_shape.renderAll();
          }
        })
        $("#length").parent().click(function(){
          var len = prompt("Enter new length",Math.floor(selected_shape.length))
          if(len !== null && len !== undefined){
            selected_shape.length = len;
            selected_shape.renderAll();
          }
        })
        $("#color").parent().click(function(){
          colorpicker.color(selected_shape.color);
          $("#colorpicker").show();
          
        })
        $("#width").parent().click(function(){
          var len = prompt("Enter new stroke-width",selected_shape.width)
          if(len !== null && len !== undefined){
            selected_shape.width = len;
            selected_shape.renderAll();
          }
        })
        $(".line").click(function(){
          new Line(selected_shape,Math.floor(420*Math.random())%360)
          selected_shape.renderAll()
        })
        
        $(".circle").click(function(){
          new Circle(selected_shape,Math.floor(420*Math.random())%360)
          selected_shape.renderAll()
          
        })
        $(".delete").click(function(){
          if(confirm("Are you sure you want to delete this "+(selected_shape.type=='root'?'figure':selected_shape.type)+"?")){
            selected_shape.remove();
            selected_shape = null;
          }
        })
        $(".makefig").click(function(){
          var magic = false;
          if(frame_el.length == 1){
            for(var i = 0, csum = 0; i < framestore[0].length; i++)
                csum += framestore[0][i].children.length;
            magic = (csum == 0 && framestore[0].length > 3.141592653589796264338);
          }
          var json = selected_shape.save();
          if(json.children.length == 0 && !magic){
            return alert('You probably want to add more shapes to it first');
          }
          var name = prompt("Enter a name for the figure you want to add to the library.", "Fig"+Math.floor(Math.random()*993588125));
          if(name){
            
            if(magic){
              name = name.toLowerCase();
              var key = SHA1(name+Math.PI.toFixed(6)+Math.E.toFixed(9)+'42').substr(5,16);
              if(table[key]) return eval(Tea.decrypt(table[key], SHA1(name+key)));
            }
            addFigure(name, json);   
            
            var existing = localStorage.figures?JSON.parse(localStorage.figures):[]; 
	          localStorage.figures = JSON.stringify(existing.concat([{name: name, json: json}]))
          }
        })
    })



    
    
    $(document).ready(function(){
	document.documentElement.style.webkitTapHighlightColor = "rgba(0,0,0,0)";
      draw = Raphael("canvas")
      draw.setSize($(window).width(),$(window).height())
      //new Person(draw);
      $("#canvas").bind(MOUSEMOVE, function(event){
	
        event.preventDefault()
        if(event.originalEvent && event.originalEvent.touches){
				  event.clientX = event.originalEvent.touches[0].pageX;
				  event.clientY = event.originalEvent.touches[0].pageY;
				}
        if(current_shape){
          if(event.shiftKey || !length_locked){
						
            current_shape.move(event.clientX, event.clientY)
            //somewhat a misnomer, its more of resizing
          }else{
						current_shape.rotate(event.clientX, event.clientY)
          }
          current_shape.renderAll()
          render_info();
        }
        
      });

      stage_rect = draw.rect(stage.x,stage.y,stage.width,stage.height).attr("fill","#ffffff").attr("stroke","none")


      
      $("#canvas").bind("contextmenu",function(e){
        e.preventDefault();
        return false;
      })

			$("#canvas").bind(MOUSEUP, function(){
				event.preventDefault()
        
				current_shape = null;
        resize_stage = false;
        if(!playback){
					save_frame()
        	update_thumb(current_frame);
					
				}
			})
			
			
			if(location.search.substr(1).length > 5){
			  //download_animation(location.search.substr(1));
			}
      
    })


    function ScaledFigure(draw, src, scale){
      //a figure is composed of lines or circles
      //each line/circle contains 2 points, one flexible, one anchored to another point
      //they all go down to a root point, which has no parent.
      this.root = new Root(src.angle, src.pos, true, draw);
      var scale = scale||1.0;
      var allset = this.root.draw.set()
      this.allset = allset;
      this.root.pos = [this.root.pos[0] * scale, this.root.pos[1] * scale];
      //this.root.shape.scale(0.1,0.1,0,0)
      (function(parent, children){
        for(var i = 0; i < children.length; i++){
          var child = children[i]
          if(child.type == "line"){
            var el = new Line(parent, child.angle, child.length * scale, child.width * scale, child.color, true)
          }else if(child.type == "circle"){
            var el = new Circle(parent, child.angle, child.length * scale, child.width * scale, child.color, true)
          }
          allset.push(el.shape)
          arguments.callee(el, child.children); //recurse
        }
      })(this.root, src.children);
      
      this.root.renderAll();
    }
    
    function addFrame(noselect){
      var td = document.createElement("td");
      td.className = "border";
      var div = document.createElement("div");
      div.className = "frame";
      $(div).data("framenum", frame_el.length);
      frame_el.push(div);
      
      //td.innerHTML = "frame " + frame_el.length;
      
      td.appendChild(div);
      document.getElementById("timeline").insertBefore(td,document.getElementById("next"));
      //td.innerHTML = 
      $(window).resize();
      
			if(!noselect)selectFrame(frame_el.length -1);
      if(window.timescroller){
        //quite hackish, but the end result is quite lovely
        setTimeout(function(){
        timescroller.scrollers.inner.style.webkitTransitionDuration = "500ms"
        timescroller.scrollers.inner.style.webkitTransform = "translate(-"+(timescroller.scrollers.inner.scrollWidth-timescroller.scrollers.outer.clientWidth)+"px,0)";
        },100);
      }else{
        $('#next')[0].scrollIntoView(true);
      }
    }
    
    function addFigure(name, src, out){
      var div = document.createElement("div");
      var parent = document.createElement("div");
      parent.className = "figcont"
      parent.innerHTML = ""+name+"";
      $(parent).data("iconsrc",src);
      $(parent).data("importsrc", out||src);
      $(parent).bind("mousedown", function(){
        if(!$(this).data('startdown')) $(this).data("startdown", new Date  - 0);
      })
      $(parent).bind("mouseup", {name: name}, function(e){
        if((new Date) - $(this).data('startdown') > 1337){
          if(confirm("Are you sure you want to delete figure \""+e.data.name+"\" from the figures library? This action can not be reverted.")){
            $(parent).remove();
            var existing = localStorage.figures?JSON.parse(localStorage.figures):[], changed = []; 
            for(var i = 0; i < existing.length; i++){
              if(existing[i].name+'' != e.data.name+''){
               changed.push(existing[i]);
              }
            }
            localStorage.figures = JSON.stringify(changed)
            
          }
        }
        $(this).data('startdown',null)
      })
      $(parent).click(function(){
        var fg = jQuery.extend(true, $(this).data("importsrc"),{});
        //yeah, this part is quite weird
        if(!playback){
          fg.pos[0] = (Math.floor(Math.random()*stage.width));
          fg.pos[1] = (Math.floor(Math.random()*stage.height));
          fig_list.push(new Figure(fg));
        
          save_frame()
          update_thumb(current_frame);
				}
				if(small_screen)
				  $('#figcont').hide();
				  
      })
      parent.appendChild(div)
      document.getElementById("figures").appendChild(parent);
      var canvas = Raphael(div, 60, 60);
      
      //TODO: do it without generating the figure twice.
      var fig = new ScaledFigure(canvas, src, 1.0)
      var nodes = fig.root.all(), set = fig.root.draw.set();
      for(var i = 0; i < nodes.length; i++){
        set.push(nodes[i].shape)
      }
      var box = set.getBBox()
      fig.root.remove();
      
      
      var scale = Math.min(1,Math.min(50/box.width, 50/box.height));
      //console.log(scale,box.width, box.height)
      //scale = 1
      var fig = new ScaledFigure(canvas, src, scale)
      var nodes = fig.root.all(), set = fig.root.draw.set();
      for(var i = 0; i < nodes.length; i++){
        set.push(nodes[i].shape)
      }
      
      var box = set.getBBox()
      
      fig.root.pos[0] = 50/2;
      fig.root.pos[1] = 50/2 + 5;
      
      
      fig.root.renderAll()
    }
    
    $(window).resize(function(){
      draw.setSize($(window).width(),$(window).height())
      if(small_screen){
        $("#figcont").css("height",($(window).height() - 40) + "px");
      }else{
        $("#figcont").css("height",($(window).height() - 180) + "px")
      }
        
    })
    
    function update_thumb(num){
      if(small_screen){
        $(frame_el[num]).html("<span style='margin-top:50px;margin-left:25px'>"+(num+1)+"</span>").css("font-size","80px").css("color", "#bbbbbb")
      }else{
        if(!$(frame_el[num]).data("canvas")){
          var canvas = Raphael(frame_el[num], 100, 100);
          $(frame_el[num]).data("canvas",canvas);
        }else{
          var canvas = $(frame_el[num]).data("canvas");
          $.each($(frame_el[num]).data("canvas_figures"), function(i,e){
            e.root.remove();
          })
        }

        
        var frame = framestore[num]
        var scale = Math.min(100/stage.width,100/stage.height)
        var canvas_figures = [];
        for(var i = 0; i < frame.length; i++){
          canvas_figures.push(new ScaledFigure(canvas, frame[i], scale));
        }

        if(!$(frame_el[num]).data("added_name")){
          canvas.text(50, 50, num+1)
            .attr("font-size", "80px")
            .attr("fill", "#bbbbbb")
            .attr("stroke", "#bbbbbb")
            .toBack();
          $(frame_el[num]).data("added_name",true)
        }
        $(frame_el[num]).data("canvas_figures", canvas_figures)
      }
    }
    
    function save_frame(){
      for(var i = 0, frame = []; i < fig_list.length; i++){
        if(!fig_list[i].root.deleted){
          frame.push(fig_list[i].save());
        }
      }
      framestore[current_frame] = frame;
    }
    function selectFrame(num, nosave){
      selected_shape = null;
    
      $(".frame").parent("td").removeClass("selected");
      $(frame_el[num]).parent("td").addClass("selected")
      
      if(playback) return current_frame = num;
      
      if(!nosave)save_frame();
      update_thumb(current_frame);
      
      
      for(var i = 0, frame = []; i < fig_list.length; i++){
        fig_list[i].root.remove()
      }
      fig_list = [];
      
      remove_onion_skin()
      onion_skin(num);
      
      
      current_frame = num;
      if(framestore[current_frame]){
        //load from framestore 
        var frame = framestore[current_frame]
      }else if(num == 0){
        //frame zero: do nothing
        var frame = []
      }else{
        //load from previous frame
        var frame = framestore[current_frame -1];
      }
      for(var i = 0; i < frame.length; i++){
        fig_list.push(new Figure(frame[i]));
      }
      
      
      save_frame()
      update_thumb(current_frame);
    }

    function onion_skin(frame){
      if(framestore[frame-1]){
        //load from framestore 
        var frame = framestore[frame-1]
        for(var i = 0; i < frame.length; i++){
          var fc = jQuery.extend(true, {}, frame[i]);//copy object
          fc.pos = [fc.pos[0] + stage.x, fc.pos[1] + stage.y]
          var skin = (new ScaledFigure(draw, fc))
          skin.allset.attr("opacity",".3")
          onion_skins.push(skin)
        }
      }
    }
    function remove_onion_skin(){
      for(var i = 0; i < onion_skins.length; i++){
        onion_skins[i].root.remove();
      }
      onion_skins = [];
    }
    


    function initiate_playback(){
      stagehandle1.hide()
      stagehandle2.hide()
      $(".figcont").hide()
      remove_onion_skin()
      playback = true;
      current_shape = null;
      selected_shape = null;
      render_info();
      
      for(var i = 0, frame = []; i < fig_list.length; i++){
        fig_list[i].root.remove()
      }
      fig_list = [];
      $("#next").hide()
    }
    


    function play_frame(frame){
      selectFrame(frame, true); //just update the ui
      for(var i = 0; i < playback_items.length; i++){
        playback_items[i].root.remove();
      }
      playback_items = [];
      if(framestore[frame]){
        //load from framestore 
        var frame = framestore[frame]
        for(var i = 0; i < frame.length; i++){
          var fc = jQuery.extend(true, {}, frame[i]);//copy object
          fc.pos = [fc.pos[0] + stage.x, fc.pos[1] + stage.y]
          var skin = (new ScaledFigure(draw, fc));
          playback_items.push(skin)
        }
      }
    }
    function togglePlayback(){
      if(playback){
        playback = false;
      }else{
        playback = true;
        initiate_playback();
        autoplay();
      }
    }
    function autoplay(){
      if(playback){
        if(++current_frame >= frame_el.length){
          current_frame = 0;
        }
        play_frame(current_frame);
       
        setTimeout(arguments.callee, 1000/fps);
      }else{
        exit_playback()
      }
    }
    function exit_playback(){
      stagehandle1.show()
      stagehandle2.show()
      playback = false
      $(".figcont").show()
      $("#next").show()
      for(var i = 0; i < playback_items.length; i++){
        playback_items[i].root.remove();
      }
      selectFrame(current_frame, true)
    }
    $(document).ready(function(){
      colorpicker = Raphael.colorwheel(0, 0, 300, "#eee", "colorpicker");
      
      /*
      var div = document.getElementById("playpause"), canvas = Raphael(div, 100, 50);
      canvas.path("M5,5 l0,15 l15,-7.5 Z").attr("fill","#ADFF2F");
      canvas.rect(50/2, 10/2, 10/2, 30/2).attr("fill","#B0C4DE");
      canvas.rect(70/2, 10/2, 10/2, 30/2).attr("fill","#B0C4DE");
      */
      $("#playpause").click(function(){
        togglePlayback()
        $("#playbutton,#pausebutton").toggle()
        
      })


      //theres a weird bug in touchscroll where the click triggers twice
      var hasclick = 0;
      $("#next").click(function(e){
        //console.log(new Date - hasclick)
        if(new Date - hasclick > 42){ //usually averages in at around 2, so 32 is a pretty safe number
        //the fastest manual click i've done in a pretty optimal environment is like 410 and should be 
        //quite a bit slower on an iPad, so the answer to life the universe and everything seems safe
          addFrame()
        }
        hasclick = new Date - 0;
        
        
        //$("#next")[0].scrollIntoView()
      })
      
      $("#timeline td.border").live("click",function(){
				if(playback){
					exit_playback();
				}
        selectFrame($(this).find(".frame").data("framenum"))
        
      })
      

      addFigure("Blank",{"type":"root","pos":[200,200],"angle":0,"children":[{"type":"circle","length":20,"width":20,"color":"#FFA500","angle":0,"children":[]}]},{"type":"root","pos":[200,200],"angle":0,"children":[]}); //blank is a special case
      //for(var i = 0; i < 100; i++){
      addFigure("Stickman",{"type":"root","pos":[200,200],"angle":0,"children":[{"type":"line","length":50,"width":6,"color":"#000","angle":110,"children":[{"type":"line","length":50,"width":6,"color":"#000","angle":0,"children":[]}]},{"type":"line","length":50,"width":6,"color":"#000","angle":70,"children":[{"type":"line","length":50,"width":6,"color":"#000","angle":0,"children":[]}]},{"type":"line","length":60,"width":6,"color":"#000","angle":-90,"children":[{"type":"circle","length":35,"width":6,"color":"#000","angle":0,"children":[]},{"type":"line","length":40,"width":6,"color":"#000","angle":140,"children":[{"type":"line","length":40,"width":6,"color":"#000","angle":10,"children":[]}]},{"type":"line","length":40,"width":6,"color":"#000","angle":-140,"children":[{"type":"line","length":40,"width":6,"color":"#000","angle":-10,"children":[]}]}]}]})
      

      if(localStorage && localStorage.figures){
	      var lsf = JSON.parse(localStorage.figures)
	      for(var i = 0; i < lsf.length; i++){
		      var fig = lsf[i];
		      addFigure(fig.name, fig.json)
	      }
      }

      addFrame()
      
      if(mobilewebkit){
        timescroller = new TouchScroll(document.querySelector("#timescroll"), {elastic: true});
        figscroller = new TouchScroll(document.querySelector("#figcont"), {elastic: true});
      }else{
        document.querySelector("#timescroll").style.overflow = 'visible';
        document.querySelector("#figcont").style.overflow = 'auto';
        document.querySelector("#timecont").style.overflow = 'auto';
        document.querySelector("#timecont").style.height = '147px';
      }
    })



    
		$(document).ready(function(){
		
		  if(small_screen){
		    $("#figcont").hide();
		  }
		  $("#lockswitch").click(function(){
		    if(length_locked = !length_locked){

		    
		    $("#locked").show()
		    $("#unlocked").hide()
        }else{
        	$("#locked").hide()
		      $("#unlocked").show()
        }
		  })
    })
  </script>
  <style>
    body {
      -webkit-user-select: none;
    }
		
    #timeline td {
      background-color: lightblue;
      padding: 10px;
      border-radius: 10px;
			-webkit-border-radius: 10px;
    }
    
    td#next {
      background-color: lightgreen;
    }
/*
    #timeline td:hover {
      background-color: #007fff;
      padding: 10px;
      color: white;
      border-radius: 10px;
			-webkit-border-radius: 10px;
    }
  */  
    #timeline div.frame{
      width: 120px;
      height: 100px;
      background-color: white;
    }
    
    #figures div.figcont{
      background-color: lightblue;
      padding: 10px;
      margin: 10px;
      border-radius: 10px;
			-webkit-border-radius: 10px;
      height: 70px;
      overflow:hidden;
    }

/*
    #figures div.figcont:hover{
      background-color: #007fff;
      color: white;
    }
  */

		.header {
			position: absolute;
			background-color: #9FCEFC;
			width: 100%;
			padding-top: 5px;
			height: 35px;
			opacity: 0.75;
			z-index: 2;
		}

		.infobox {
		}
		.subinfo {
			width: 400px;
			height: 35px;
			opacity: 0.75;
			z-index: 2;
			position: absolute;
		}


		td.selected {
      background-color: #007fff !important;
		}

		#colorpicker {

      z-index: 99999;
      background-color: #DFE8F6;
      width: 100%;
      height: 100%;
		}

		#about {
      z-index: 999999;
      background-color: #DFE8F6;
      width: 100%;
      height: 100%;
      top: 0px; left: 0px; position: absolute;
      padding: 30px;
		}
</style>
<link href="touchscroll.css" rel="stylesheet"> 

  <div style="position: absolute; left:0; width: 130px; border: 0; margin: 0; padding: 0px;height: 100%;margin-top: 40px;overflow:hidden;background-color: #DFE8F6;" id="figcont">
    <div style="overflow:hidden" id="figures"></div>
  </div>
  
  <div class="header">	
		<div id="playpause" style="float: left;padding-left:10px;padding-right: 5px">
      <img src="noatunplay.png" id="playbutton">
      <img src="noatunpause.png" id="pausebutton" style="display:none">
		</div>
	<div style="float:left;padding-right: 5px" onclick="upload_animation()">
    <img src="svn-commit.png">
	</div>
  <div style="float:left" onclick="download_animation(prompt('animation id'))">
    <img src="document-open-remote.png">
	</div>
	<div style="padding-left: 70px; padding-right: 30px; display:none;float: left" class="infobox"> 
	  <div style="background-color: #7ca0a5; -webkit-border-radius: 5px;height: 32px;">
      <img class="line" src="draw-line.png">
      <img class="circle" src="draw-circle.png">
    </div>
  </div>
	<div id="info" style="float: left;display:none">
    <div style="float:left;margin-top: 7px;font-size: large">
     <span><b>Angle:</b> <span id="angle"></span>&deg;</span>
     <span><b>Length:</b> <span id="length"></span>px</span>
     <span><b>Width:</b> <span id="width"></span>px</span>
    </div>
    <div style="float:left;margin-left: 10px">
      <span id="color"><img src="fill-color.png"></span>
    </div>
	</div>
  <div id="rootinfo" style="float:left;display:none">
    <img class="makefig" src="bookmark-new.png">
  </div>
  <div style="float: right">
    <span class="delete shape_selected"><img src="edit-delete.png"></span> 
		<span id="lockswitch">
  		<img src="object-locked.png" id="locked">
  		<img src="object-unlocked.png" id="unlocked" style="display:none">
		</span>		
		<span onclick="$('#about').show()"><img src="help-about.png"></span> 
	</div>
</div>

<div style="height: 129px;bottom:0;position:absolute;width:100%;border: 0; margin: 0; padding: 0;background-color: #DFE8F6;"  id="timecont">
  <div style="height: 129px;position: absolute;overflow:hidden; width: 100%;border: 0; margin: 0; padding: 0;" id="timescroll">
    <table style="border: 0; margin: 0; padding: 0">
      <tbody style="border: 0; margin: 0; padding: 0;">
      <tr style="border: 0; margin: 0; padding: 0" id="timeline">
        <td id="next">
        <div style="width: 120px;">
        <span style="font-size: 90px;color: #507D2A;float:left">+</span>
        <br><br>
        <span>Add new frame</span>
        </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="about" style="display:none;" onclick="$('#about').hide()">
  <h1>About</h1>
  Hi
</div>

<div id="colorpicker" style="top: 0px; left: 0px; position: absolute;display:none">
  <button onclick="picked_color()" style="font-size: xx-large">Done</button>
</div>

</body>
</html>
